name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:

  build-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build and test Product Service
        working-directory: ./productService
        run: mvn clean test

      - name: Build and test Order Service
        working-directory: ./orderService
        run: mvn clean test

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            productService/target/surefire-reports
            orderService/target/surefire-reports

  docker-integration:
    name: Docker Build and Integration Test
    runs-on: ubuntu-latest
    needs: build-test

    env:
      UNLEASH_ADMIN_TOKEN: ${{ secrets.UNLEASH_ADMIN_TOKEN }}
      UNLEASH_API_TOKEN: default-client-token

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose build

      - name: Start full stack
        run: docker compose up -d

      - name: Wait for PostgreSQL
        run: |
          until docker inspect --format='{{.State.Health.Status}}' postgres | grep healthy; do
            echo "Waiting for PostgreSQL..."
            sleep 5
          done

      - name: Wait for Unleash
        run: |
          until docker inspect --format='{{.State.Health.Status}}' unleash-server | grep healthy; do
            echo "Waiting for Unleash..."
            sleep 5
          done

      - name: Wait for Product Service
        run: |
          until curl -f http://localhost:8081/api/products; do
            echo "Waiting for Product Service..."
            sleep 5
          done

      - name: Wait for Order Service
        run: |
          until curl -f http://localhost:8082/api/orders; do
            echo "Waiting for Order Service..."
            sleep 5
          done

      - name: Initialize feature flags
        env:
          UNLEASH_ADMIN_TOKEN: ${{ secrets.UNLEASH_ADMIN_TOKEN }}
        run: |
          chmod +x scripts/init-flags.sh
          scripts/init-flags.sh
    

      - name: Create sample product for testing
        run: |
          curl -X POST http://localhost:8081/api/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Test Product","price":100.0,"quantity":10}'

      - name: Verify core endpoints
        run: |
          curl -f http://localhost:8081/api/products
          curl -f http://localhost:8081/api/products/premium
          curl -f http://localhost:8082/api/orders

      - name: Tear down stack
        if: always()
        run: docker compose down -v